# Supabase Storage Setup for Digital Products

## Overview
This guide explains how to set up Supabase Storage for hosting digital product files.

---

## Prerequisites

- Supabase project already exists (currently used for photos)
- Service role key available in environment variables
- Database connection configured

---

## Step 1: Create Storage Bucket

### Via Supabase Dashboard

1. Go to https://supabase.com/dashboard
2. Select your project
3. Navigate to **Storage** in the left sidebar
4. Click **New bucket**
5. Configure the bucket:
   - **Name:** `digital-products`
   - **Public bucket:** ❌ NO (files should be private)
   - **File size limit:** 500 MB
   - **Allowed MIME types:** Leave empty (allow all)

### Via SQL (Alternative)

```sql
-- Create the storage bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('digital-products', 'digital-products', false);
```

---

## Step 2: Configure Storage Policies

Digital product files should only be accessible via signed URLs generated by the backend.

### Policy 1: Allow Service Role to Upload

```sql
-- Allow service role to upload files
CREATE POLICY "Service role can upload digital products"
ON storage.objects
FOR INSERT
TO service_role
WITH CHECK (bucket_id = 'digital-products');
```

### Policy 2: Allow Service Role to Read

```sql
-- Allow service role to read files (for generating signed URLs)
CREATE POLICY "Service role can read digital products"
ON storage.objects
FOR SELECT
TO service_role
USING (bucket_id = 'digital-products');
```

### Policy 3: Allow Service Role to Delete

```sql
-- Allow service role to delete files
CREATE POLICY "Service role can delete digital products"
ON storage.objects
FOR DELETE
TO service_role
USING (bucket_id = 'digital-products');
```

### Policy 4: Allow Service Role to Update

```sql
-- Allow service role to update file metadata
CREATE POLICY "Service role can update digital products"
ON storage.objects
FOR UPDATE
TO service_role
USING (bucket_id = 'digital-products');
```

---

## Step 3: Environment Variables

Ensure these environment variables are set in your Doppler configuration:

```bash
# Supabase Configuration (already set for photos)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

**Note:** The service role key has full access to storage, so keep it secure and never expose it to the frontend.

---

## Step 4: Folder Structure

Files will be organized in the bucket as follows:

```
digital-products/
├── {tenant_id}/
│   ├── {product_id}/
│   │   ├── asset_{timestamp}_{random}_filename.pdf
│   │   ├── asset_{timestamp}_{random}_ebook.epub
│   │   └── asset_{timestamp}_{random}_software.zip
│   └── {product_id}/
│       └── asset_{timestamp}_{random}_course.mp4
└── {tenant_id}/
    └── {product_id}/
        └── asset_{timestamp}_{random}_template.psd
```

**Benefits:**
- Easy to identify files by tenant and product
- Simple cleanup when products are deleted
- Prevents filename conflicts with unique asset IDs

---

## Step 5: Test Storage Access

Run this test to verify storage is configured correctly:

```typescript
// Test file: apps/api/src/services/digital-assets/test-storage.ts
import { digitalAssetService } from './DigitalAssetService';

async function testStorage() {
  console.log('Testing Supabase Storage access...');
  
  // Check bucket access
  const hasAccess = await digitalAssetService.checkBucketAccess();
  console.log('Bucket access:', hasAccess ? '✅ OK' : '❌ FAILED');
  
  if (!hasAccess) {
    console.error('Cannot access digital-products bucket. Check:');
    console.error('1. Bucket exists in Supabase');
    console.error('2. SUPABASE_URL is correct');
    console.error('3. SUPABASE_SERVICE_ROLE_KEY is correct');
    console.error('4. Storage policies are configured');
    return;
  }
  
  // Test file upload
  const testFile = Buffer.from('Test digital product file');
  const testTenantId = 'test-tenant';
  const testProductId = 'test-product';
  
  try {
    const asset = await digitalAssetService.uploadFile(
      testTenantId,
      testProductId,
      testFile,
      'test-file.txt',
      'text/plain'
    );
    console.log('Upload test:', '✅ OK');
    console.log('Asset ID:', asset.id);
    
    // Test signed URL generation
    const signedUrl = await digitalAssetService.generateSignedUrl(asset.file_path!, 60);
    console.log('Signed URL test:', '✅ OK');
    console.log('URL expires in 60 seconds');
    
    // Test file deletion
    await digitalAssetService.deleteAsset(asset.file_path!);
    console.log('Delete test:', '✅ OK');
    
    console.log('\n✅ All storage tests passed!');
  } catch (error) {
    console.error('❌ Storage test failed:', error);
  }
}

testStorage();
```

Run the test:
```bash
cd apps/api
doppler run -- npx tsx src/services/digital-assets/test-storage.ts
```

---

## Step 6: Storage Limits & Quotas

### Supabase Free Tier
- **Storage:** 1 GB
- **Bandwidth:** 2 GB/month
- **File uploads:** 50 MB max per file

### Supabase Pro Tier
- **Storage:** 100 GB included
- **Bandwidth:** 200 GB/month included
- **File uploads:** 5 GB max per file
- **Additional storage:** $0.021/GB/month
- **Additional bandwidth:** $0.09/GB

### Recommendations
- **Free tier:** Suitable for testing and small catalogs
- **Pro tier:** Required for production with multiple digital products
- **Monitor usage:** Set up alerts in Supabase dashboard

---

## Step 7: Security Best Practices

### ✅ DO:
- Use signed URLs with short expiration (1 hour default)
- Validate access tokens before generating signed URLs
- Track download counts and enforce limits
- Revoke access when orders are refunded
- Use service role key only on backend
- Sanitize file names before upload

### ❌ DON'T:
- Make the bucket public
- Expose service role key to frontend
- Generate signed URLs without access validation
- Allow unlimited downloads without tracking
- Store sensitive data in file metadata
- Use predictable file paths

---

## Step 8: Monitoring & Maintenance

### Storage Usage Dashboard
Monitor storage usage in Supabase Dashboard:
- **Storage** → **Usage** tab
- Track total storage used
- Monitor bandwidth consumption
- Set up usage alerts

### Cleanup Strategy
Implement automated cleanup for:
- Deleted products (remove associated files)
- Expired access grants (optional - keep for audit)
- Test files (remove after testing)

### Backup Strategy
Supabase provides automatic backups, but consider:
- Keeping original files in separate backup location
- Documenting file restoration procedures
- Testing restore process periodically

---

## Troubleshooting

### "Bucket not found" Error
- Verify bucket name is exactly `digital-products`
- Check bucket exists in Supabase Dashboard
- Ensure SUPABASE_URL is correct

### "Permission denied" Error
- Verify storage policies are created
- Check SUPABASE_SERVICE_ROLE_KEY is correct
- Ensure service role has storage permissions

### "File too large" Error
- Check file size against tier limits
- Consider splitting large files
- Upgrade to Pro tier if needed

### "Signed URL expired" Error
- This is expected behavior for security
- Generate new signed URL for each download
- Consider shorter expiration times (15-30 minutes)

---

## Next Steps

After completing storage setup:

1. ✅ Run storage test script
2. ✅ Verify all tests pass
3. ✅ Set up monitoring alerts
4. ✅ Document backup procedures
5. ⏭️ Proceed to Phase 2: Product Management UI

---

## Support Resources

- **Supabase Storage Docs:** https://supabase.com/docs/guides/storage
- **Storage Policies:** https://supabase.com/docs/guides/storage/security/access-control
- **Signed URLs:** https://supabase.com/docs/guides/storage/serving/downloads
- **Supabase Dashboard:** https://supabase.com/dashboard
