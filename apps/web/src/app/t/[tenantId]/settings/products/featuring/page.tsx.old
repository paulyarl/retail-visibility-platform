"use client";

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import { Star, TrendingUp, Eye, Sparkles, Check, X, Search, ArrowUp, ArrowDown, Package, Download, Layers, AlertTriangle, Timer, Clock, Edit2, Play, Pause, Calendar, Tag, Award } from 'lucide-react';
import { api } from '@/lib/api';
import Image from 'next/image';

interface Product {
  id: string;
  sku: string;
  name: string;
  title?: string;
  brand?: string;
  description?: string;
  price_cents: number;
  sale_price_cents?: number;
  stock: number;
  image_url?: string;
  is_featured: boolean;
  featured_at?: string;
  featured_until?: string;
  featured_priority: number;
  has_variants?: boolean;
  availability?: string;
  product_type?: string;
  featured_type?: string;
  featured_types?: string[]; // New field for multiple featured types
  item_status?: string; // Base table status
  visibility?: string; // Base table visibility
  // Junction table fields
  is_active?: boolean;
  featured_expires_at?: string;
  featured_types_active?: string[]; // Active featured types from junction table
  is_featured_active?: boolean;
  days_until_expiration?: number;
  is_expired?: boolean;
  is_expiring_soon?: boolean;
  // Inactivity reason fields
  inactivityReason?: 'paused' | 'expired' | 'out_of_stock';
  reasonText?: string;
}

interface FeaturingStatus {
  tier: string;
  limit: number;
  current: number;
  available: number;
  canFeature: boolean;
}

interface Tenant {
  id: string;
  name: string;
  subscription_tier: string;
}

// Helper functions for featured type badges
const getFeaturedBadgeStyle = (typeId: string): string => {
  switch (typeId) {
    case 'store_selection':
      return 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white';
    case 'new_arrival':
      return 'bg-gradient-to-r from-green-500 to-emerald-500 text-white';
    case 'seasonal':
      return 'bg-gradient-to-r from-orange-500 to-red-500 text-white';
    case 'sale':
      return 'bg-gradient-to-r from-red-500 to-pink-500 text-white';
    case 'staff_pick':
      return 'bg-gradient-to-r from-purple-500 to-indigo-500 text-white';
    default:
      return 'bg-gradient-to-r from-amber-500 to-orange-500 text-white';
  }
};

const getFeaturedBadgeIcon = (typeId: string) => {
  switch (typeId) {
    case 'store_selection':
      return <Star className="w-3 h-3 fill-white" />;
    case 'new_arrival':
      return <Sparkles className="w-3 h-3 fill-white" />;
    case 'seasonal':
      return <Calendar className="w-3 h-3 fill-white" />;
    case 'sale':
      return <Tag className="w-3 h-3 fill-white" />;
    case 'staff_pick':
      return <Award className="w-3 h-3 fill-white" />;
    default:
      return <Star className="w-3 h-3 fill-white" />;
  }
};

const getFeaturedBadgeText = (typeId: string, currentTypeName?: string): string => {
  if (currentTypeName && currentTypeName !== 'Directory Featured') {
    switch (typeId) {
      case 'store_selection':
        return currentTypeName;
      case 'new_arrival':
        return 'New';
      case 'seasonal':
        return 'Seasonal';
      case 'sale':
        return 'Sale';
      case 'staff_pick':
        return 'Staff Pick';
      default:
        return 'Featured';
    }
  }
  
  switch (typeId) {
    case 'store_selection':
      return 'Directory';
    case 'new_arrival':
      return 'New';
    case 'seasonal':
      return 'Seasonal';
    case 'sale':
      return 'Sale';
    case 'staff_pick':
      return 'Staff Pick';
    default:
      return 'Featured';
  }
};

// Helper functions for inactive product grouping
const getInactiveProductGroups = (products: Product[]) => {
  const groups = {
    paused: products.filter(p => p.inactivityReason === 'paused'),
    expired: products.filter(p => p.inactivityReason === 'expired'),
    out_of_stock: products.filter(p => p.inactivityReason === 'out_of_stock')
  };
  return groups;
};

const getInactiveGroupInfo = (reason: 'paused' | 'expired' | 'out_of_stock') => {
  switch (reason) {
    case 'paused':
      return {
        title: 'Paused Products',
        description: 'Products manually paused by merchant',
        icon: <Pause className="w-5 h-5" />,
        color: 'bg-orange-50 border-orange-200',
        badgeColor: 'bg-orange-500',
        action: 'Resume'
      };
    case 'expired':
      return {
        title: 'Expired Products',
        description: 'Products whose featuring period has ended',
        icon: <Timer className="w-5 h-5" />,
        color: 'bg-red-50 border-red-200',
        badgeColor: 'bg-red-500',
        action: 'Extend'
      };
    case 'out_of_stock':
      return {
        title: 'Out of Stock Products',
        description: 'Products that ran out of stock and were auto-removed',
        icon: <X className="w-5 h-5" />,
        color: 'bg-gray-50 border-gray-200',
        badgeColor: 'bg-gray-500',
        action: 'Restock'
      };
  }
};

// Helper functions for out-of-stock product grouping
const getOutOfStockGroups = (neverFeatured: Product[], previouslyFeatured: Product[]) => {
  return {
    neverFeatured,
    previouslyFeatured
  };
};

const getOutOfStockGroupInfo = (type: 'neverFeatured' | 'previouslyFeatured') => {
  switch (type) {
    case 'neverFeatured':
      return {
        title: 'Never Featured',
        description: 'Products that have never been featured but are out of stock',
        icon: <Package className="w-5 h-5" />,
        color: 'bg-blue-50 border-blue-200',
        badgeColor: 'bg-blue-500',
        action: 'Stock to Feature'
      };
    case 'previouslyFeatured':
      return {
        title: 'Previously Featured',
        description: 'Products that were featured but went out of stock',
        icon: <AlertTriangle className="w-5 h-5" />,
        color: 'bg-purple-50 border-purple-200',
        badgeColor: 'bg-purple-500',
        action: 'Restock & Re-feature'
      };
  }
};

function SimpleTierBadge({ tier }: { tier: string }) {
  const getTierInfo = (tierLevel: string) => {
    switch (tierLevel) {
      case 'trial':
        return { color: 'bg-orange-100 text-orange-700 border-orange-300', icon: 'üß™', name: 'Trial' };
      case 'google_only':
        return { color: 'bg-blue-100 text-blue-700 border-blue-300', icon: 'üîç', name: 'Google Only' };
      case 'starter':
        return { color: 'bg-neutral-100 text-neutral-700 border-neutral-300', icon: 'üå±', name: 'Starter' };
      case 'growth':
        return { color: 'bg-green-100 text-green-700 border-green-300', icon: 'üìà', name: 'Growth' };
      case 'professional':
        return { color: 'bg-purple-100 text-purple-700 border-purple-300', icon: '‚≠ê', name: 'Professional' };
      case 'enterprise':
        return { color: 'bg-amber-100 text-amber-700 border-amber-300', icon: 'üè¢', name: 'Enterprise' };
      case 'organization':
        return { color: 'bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 border-purple-300', icon: 'üíé', name: 'Organization' };
      default:
        return { color: 'bg-gray-100 text-gray-700 border-gray-300', icon: 'üì¶', name: tierLevel };
    }
  };

  const tierInfo = getTierInfo(tier);

  return (
    <div className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full border ${tierInfo.color}`}>
      <span className="text-lg">{tierInfo.icon}</span>
      <span className="font-semibold text-sm">{tierInfo.name}</span>
    </div>
  );
}

// Check if product is "active" (not paused) - for legacy system using featured_until
const isProductActive = (product: Product): boolean => {
  if (!product.featured_until) return true; // No expiration means active
  const now = new Date();
  const expiresAt = new Date(product.featured_until);
  return expiresAt > now; // Active if expiration is in the future
};
const getExpirationStatus = (product: Product): {
  isExpired: boolean;
  isExpiringSoon: boolean;
  daysRemaining: number;
  statusColor: string;
  statusText: string;
} => {
  if (!product.featured_until) {
    return {
      isExpired: false,
      isExpiringSoon: false,
      daysRemaining: -1,
      statusColor: 'text-gray-500',
      statusText: 'No expiration'
    };
  }

  const now = new Date();
  const expiresAt = new Date(product.featured_until);
  const daysRemaining = Math.ceil((expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
  
  const isExpired = daysRemaining < 0;
  const isExpiringSoon = daysRemaining >= 0 && daysRemaining <= 3;

  let statusColor = 'text-green-600';
  let statusText = `${daysRemaining} days`;

  if (isExpired) {
    statusColor = 'text-red-600';
    statusText = 'Expired';
  } else if (isExpiringSoon) {
    statusColor = 'text-amber-600';
    statusText = daysRemaining === 0 ? 'Expires today' : `${daysRemaining} days`;
  }

  return {
    isExpired,
    isExpiringSoon,
    daysRemaining,
    statusColor,
    statusText
  };
};

function getProductTypeIcon(productType?: string) {
  switch (productType) {
    case 'physical':
      return <Package className="w-4 h-4 text-gray-500" />;
    case 'digital':
      return <Download className="w-4 h-4 text-blue-500" />;
    default:
      return <Package className="w-4 h-4 text-gray-500" />;
  }
}

function getFeaturedTypeBadges(featuredTypes?: string[], featuredType?: string) {
  // Use featured_types array if available, otherwise fall back to single featured_type
  const types = featuredTypes || (featuredType ? [featuredType] : []);
  
  if (types.length === 0) return null;
  
  const badgeConfig = {
    store_selection: { color: 'bg-blue-100 text-blue-700', label: 'Store Selection' },
    new_arrival: { color: 'bg-green-100 text-green-700', label: 'New Arrival' },
    seasonal: { color: 'bg-orange-100 text-orange-700', label: 'Seasonal' },
    sale: { color: 'bg-red-100 text-red-700', label: 'Sale' },
    staff_pick: { color: 'bg-purple-100 text-purple-700', label: 'Staff Pick' },
  };
  
  return (
    <div className="flex flex-wrap gap-1">
      {types.map((type) => {
        const config = badgeConfig[type as keyof typeof badgeConfig];
        if (!config) return null;
        
        return (
          <span
            key={type}
            className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${config.color}`}
          >
            {config.label}
          </span>
        );
      })}
    </div>
  );
}

export default function ProductFeaturingPage() {
  const params = useParams();
  const tenantId = params.tenantId as string;

  const [loading, setLoading] = useState(true);
  const [status, setStatus] = useState<FeaturingStatus | null>(null);
  const [featuredProducts, setFeaturedProducts] = useState<Product[]>([]);
  const [availableProducts, setAvailableProducts] = useState<Product[]>([]);
  const [outOfStockProducts, setOutOfStockProducts] = useState<Product[]>([]);
  const [inactiveProducts, setInactiveProducts] = useState<Product[]>([]);
  const [previouslyFeaturedOutOfStock, setPreviouslyFeaturedOutOfStock] = useState<Product[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [processing, setProcessing] = useState(false);
  const [tenant, setTenant] = useState<Tenant | null>(null);
  const [availablePage, setAvailablePage] = useState(1);
  const [editingExpiration, setEditingExpiration] = useState<string | null>(null);
  const [expirationDate, setExpirationDate] = useState('');
  const [togglingActive, setTogglingActive] = useState(false);
  
  const itemsPerPage = 12;

  // Filter expired products
  const expiredFeatured = featuredProducts.filter(product => {
    const status = getExpirationStatus(product);
    return status.isExpired;
  });

  const fetchTenant = async () => {
    try {
      const response = await api.get(`/api/tenants/${tenantId}`);
      if (response.ok) {
        const data = await response.json();
        setTenant(data);
      }
    } catch (error) {
      console.error('Error fetching tenant:', error);
    }
  };

  useEffect(() => {
    fetchData();
    fetchTenant();
  }, [tenantId]);

  useEffect(() => {
    setAvailablePage(1); // Reset to page 1 when search changes
  }, [searchQuery]);

  const fetchData = async () => {
    setLoading(true);
    try {
      const [statusRes, featuredRes, productsRes, inactiveRes, outOfStockFeaturedRes] = await Promise.all([
        api.get(`/api/tenants/${tenantId}/products/featuring/status`),
        api.get(`/api/tenants/${tenantId}/products/featured`),
        api.get(`/api/tenants/${tenantId}/items?limit=100`),
        api.get(`/api/tenants/${tenantId}/products/featured/inactive`),
        api.get(`/api/tenants/${tenantId}/products/featured/out-of-stock`)
      ]);

      if (statusRes.ok) {
        const statusData = await statusRes.json();
        setStatus(statusData);
      }

      // Get all products data
      const [featuredData, productsData, inactiveData, outOfStockFeaturedData] = await Promise.all([
        featuredRes.ok ? featuredRes.json() : Promise.resolve({ products: [] }),
        productsRes.ok ? productsRes.json() : Promise.resolve({ items: [] }),
        inactiveRes.ok ? inactiveRes.json() : Promise.resolve({ products: [] }),
        outOfStockFeaturedRes.ok ? outOfStockFeaturedRes.json() : Promise.resolve({ products: [] })
      ]);

      // Process featured products (active store_selection only)
      const featuredProducts = featuredData.products || [];
      const uniqueFeaturedProducts = Array.from(
        new Map(featuredProducts.map((product: Product) => [product.id, product])).values()
      ) as Product[];
      setFeaturedProducts(uniqueFeaturedProducts);

      // Process available products (active products WITH stock WITHOUT store_selection featured type)
      const allProducts = productsData.items || [];
      const featuredProductIds = uniqueFeaturedProducts.map((p: Product) => p.id);
      const available = allProducts.filter((p: Product) => 
        !featuredProductIds.includes(p.id) && 
        p.item_status === 'active' && 
        p.visibility === 'public' &&
        p.stock > 0 // Must have stock
      );
      setAvailableProducts(available);

      // Process out of stock products (active products without stock, excluding featured)
      const outOfStock = allProducts.filter((p: Product) => 
        !featuredProductIds.includes(p.id) && 
        p.item_status === 'active' && 
        p.visibility === 'public' &&
        p.stock <= 0 // No stock
      );
      setOutOfStockProducts(outOfStock);

      // Process inactive products (paused only)
      const inactiveProducts = inactiveData.products || [];
      const uniqueInactiveProducts = Array.from(
        new Map(inactiveProducts.map((product: Product) => [product.id, product])).values()
      ) as Product[];
      setInactiveProducts(uniqueInactiveProducts);

      // Process previously featured out-of-stock products
      const previouslyFeaturedOutOfStock = outOfStockFeaturedData.products || [];
      const uniquePreviouslyFeaturedOutOfStock = Array.from(
        new Map(previouslyFeaturedOutOfStock.map((product: Product) => [product.id, product])).values()
      ) as Product[];
      setPreviouslyFeaturedOutOfStock(uniquePreviouslyFeaturedOutOfStock);
    } catch (error) {
      console.error('Error fetching data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleFeature = async (productId: string) => {
    if (!status?.canFeature) {
      alert(`You've reached your featuring limit (${status?.limit} products for ${status?.tier} tier)`);
      return;
    }

    setProcessing(true);
    try {
      const response = await api.post(`/api/tenants/${tenantId}/products/${productId}/feature`, {
        priority: 50
      });

      if (response.ok) {
        await fetchData();
      } else {
        const error = await response.json();
        alert(error.message || 'Failed to feature product');
      }
    } catch (error) {
      console.error('Error featuring product:', error);
      alert('An error occurred. Please try again.');
    } finally {
      setProcessing(false);
    }
  };

  const handleUnfeature = async (productId: string) => {
    setProcessing(true);
    try {
      const response = await api.delete(`/api/tenants/${tenantId}/products/${productId}/feature`);

      if (response.ok) {
        await fetchData();
      } else {
        alert('Failed to unfeature product');
      }
    } catch (error) {
      console.error('Error unfeaturing product:', error);
      alert('An error occurred. Please try again.');
    } finally {
      setProcessing(false);
    }
  };

  const handleToggleActive = async (productId: string, isActive: boolean) => {
    setTogglingActive(true);
    try {
      const response = await api.patch(`/api/tenants/${tenantId}/products/${productId}/feature/active`, {
        is_active: isActive
      });

      if (response.ok) {
        await fetchData();
      } else {
        const error = await response.json();
        console.error('Failed to toggle active status:', error);
        alert(error.message || 'Failed to toggle active status');
      }
    } catch (error) {
      console.error('Error toggling active status:', error);
      alert('An error occurred. Please try again.');
    } finally {
      setTogglingActive(false);
    }
  };

  const handleUpdateExpiration = async (productId: string, newExpirationDate: string) => {
    setProcessing(true);
    try {
      const response = await api.patch(`/api/tenants/${tenantId}/products/${productId}/feature/expiration`, {
        featured_until: newExpirationDate ? new Date(newExpirationDate).toISOString() : null
      });

      if (response.ok) {
        await fetchData();
        setEditingExpiration(null);
        setExpirationDate('');
      } else {
        const error = await response.json();
        console.error('Failed to update expiration:', error);
        alert(error.message || 'Failed to update expiration');
      }
    } catch (error) {
      console.error('Error updating expiration:', error);
      alert('An error occurred. Please try again.');
    } finally {
      setProcessing(false);
    }
  };

  const handleUpdatePriority = async (productId: string, newPriority: number) => {
    setProcessing(true);
    try {
      const response = await api.patch(`/api/tenants/${tenantId}/products/${productId}/feature/priority`, {
        priority: newPriority
      });

      if (response.ok) {
        await fetchData();
      }
    } catch (error) {
      console.error('Error updating priority:', error);
    } finally {
      setProcessing(false);
    }
  };

  const filteredAvailable = availableProducts.filter(p =>
    p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    p.sku.toLowerCase().includes(searchQuery.toLowerCase()) ||
    p.brand?.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // Pagination for available products
  const totalPages = Math.ceil(filteredAvailable.length / itemsPerPage);
  const startIndex = (availablePage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedAvailable = filteredAvailable.slice(startIndex, endIndex);

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading featuring settings...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Header */}
      <div className="mb-8">
        <div className="flex items-start justify-between mb-4">
          <div>
            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
              <Sparkles className="w-8 h-8 text-amber-500" />
              Featured Products
            </h1>
            <p className="mt-2 text-gray-600">
              Highlight your best products with prominent display styling
            </p>
          </div>
          {tenant?.subscription_tier && (
            <div className="text-right">
              <p className="text-xs text-gray-500 mb-1">Current Tier</p>
              <SimpleTierBadge tier={tenant.subscription_tier} />
            </div>
          )}
        </div>
      </div>

      {/* Status Card */}
      {status && (
        <div className="bg-gradient-to-r from-amber-50 to-orange-100 border-2 border-amber-200 rounded-lg p-6 mb-8">
          <div className="flex items-start justify-between">
            <div>
              <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <Star className="w-5 h-5 text-amber-600" />
                Featuring Status
              </h3>
              <p className="mt-1 text-gray-700">
                Using <span className="font-semibold">{status.current}</span> of{' '}
                <span className="font-semibold">{status.limit}</span> featured slots
              </p>
              <p className="mt-1 text-sm text-gray-600">
                Tier: <span className="font-semibold capitalize">{status.tier}</span>
              </p>
            </div>
            <div className="text-right">
              <div className="text-3xl font-bold text-amber-600">
                {status.available}
              </div>
              <div className="text-sm text-gray-600">slots available</div>
            </div>
          </div>

          {/* Progress Bar */}
          <div className="mt-4">
            <div className="w-full bg-gray-200 rounded-full h-3">
              <div
                className={`h-3 rounded-full transition-all ${
                  status.current >= status.limit
                    ? 'bg-red-500'
                    : status.current / status.limit > 0.8
                    ? 'bg-amber-500'
                    : 'bg-green-500'
                }`}
                style={{ width: `${Math.min((status.current / status.limit) * 100, 100)}%` }}
              ></div>
            </div>
          </div>

          {!status.canFeature && (
            <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
              <p className="text-sm text-red-700 font-medium">
                ‚ö†Ô∏è You've reached your featuring limit. Unfeature some products or upgrade your tier to feature more.
              </p>
            </div>
          )}
        </div>
      )}

      {/* Featured Products */}
      <div className="mb-8">
        <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Star className="w-6 h-6 text-amber-500 fill-amber-500" />
          Currently Featured ({featuredProducts.length})
        </h2>

        {featuredProducts.length === 0 ? (
          <div className="bg-white rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
            <Sparkles className="w-16 h-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">No Featured Products Yet</h3>
            <p className="text-gray-600">
              Feature your best products to give them prominent display styling and boost conversions
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {featuredProducts.map((product) => (
              <div key={product.id} className="bg-white rounded-lg border-2 border-amber-200 p-4 relative">
                {/* Featured Badge */}
                <div className="absolute top-2 left-2 z-10">
                  <span className={`inline-flex items-center gap-1 px-2 py-1 text-white text-xs font-bold rounded-full ${getFeaturedBadgeStyle(product.featured_type || 'store_selection')}`}>
                    {getFeaturedBadgeIcon(product.featured_type || 'store_selection')}
                    {getFeaturedBadgeText(product.featured_type || 'store_selection')}
                  </span>
                </div>

                {/* Product Image */}
                <div className="relative h-48 bg-gray-100 rounded-lg mb-4">
                  {product.image_url ? (
                    <Image
                      src={product.image_url}
                      alt={product.name}
                      fill
                      className="object-cover rounded-lg"
                    />
                  ) : (
                    <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                      <Eye className="w-12 h-12" />
                    </div>
                  )}
                </div>

                {/* Product Info */}
                <div className="mb-4">
                  {product.brand && (
                    <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">{product.brand}</p>
                  )}
                  <h3 className="font-semibold text-gray-900 line-clamp-2 mb-2">
                    {product.title || product.name}
                  </h3>
                  <p className="text-lg font-bold text-gray-900">
                    ${(product.price_cents / 100).toFixed(2)}
                  </p>
                  <p className="text-sm text-gray-600">SKU: {product.sku}</p>
                </div>

                {/* Active/Inactive Toggle */}
                <div className="flex items-center justify-between gap-2 p-2 bg-gray-50 rounded-lg mb-2">
                  <div className="flex items-center gap-2">
                    <span className="text-sm text-gray-600">Display Status:</span>
                    <span className={`text-xs px-2 py-1 rounded-full font-medium ${
                      (product.is_active !== false && product.is_active !== undefined) ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                    }`}>
                      {(product.is_active !== false && product.is_active !== undefined) ? 'Active' : 'Paused'}
                    </span>
                  </div>
                  <button
                    onClick={() => handleToggleActive(product.id, product.is_active === false)}
                    disabled={togglingActive}
                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                      (product.is_active !== false && product.is_active !== undefined) ? 'bg-green-600' : 'bg-gray-300'
                    } ${togglingActive ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                    title={(product.is_active !== false && product.is_active !== undefined) ? 'Pause featuring' : 'Resume featuring'}
                  >
                    <span
                      className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                        (product.is_active !== false && product.is_active !== undefined) ? 'translate-x-6' : 'translate-x-1'
                      }`}
                    />
                    <span className="absolute left-1 top-1/2 -translate-y-1/2">
                      {(product.is_active !== false && product.is_active !== undefined) ? (
                        <Play className="w-2 h-2 text-white" />
                      ) : (
                        <Pause className="w-2 h-2 text-white" />
                      )}
                    </span>
                  </button>
                </div>

                {/* Expiration Status */}
                <div className="mb-2 flex items-center gap-2 text-xs">
                  {(() => {
                    const status = getExpirationStatus(product);
                    return (
                      <>
                        <span className={status.statusColor}>
                          {status.isExpired && <AlertTriangle className="w-3 h-3" />}
                          {status.isExpiringSoon && <Timer className="w-3 h-3" />}
                          {!status.isExpired && !status.isExpiringSoon && <Clock className="w-3 h-3" />}
                        </span>
                        <span className="text-gray-600">{status.statusText}</span>
                      </>
                    );
                  })()}
                </div>

                {/* Priority and Expiration Controls */}
                <div className="space-y-3">
                  <div className="flex items-center justify-between gap-2">
                    {/* Priority Controls */}
                    <div className="flex items-center gap-2">
                      <span className="text-sm text-gray-600">Priority:</span>
                      <button
                        onClick={() => handleUpdatePriority(product.id, Math.min(product.featured_priority + 10, 100))}
                        disabled={processing}
                        className="p-1 hover:bg-gray-100 rounded disabled:opacity-50"
                        title="Increase priority"
                      >
                        <ArrowUp className="w-4 h-4" />
                      </button>
                      <span className="font-semibold text-gray-900">{product.featured_priority}</span>
                      <button
                        onClick={() => handleUpdatePriority(product.id, Math.max(product.featured_priority - 10, 0))}
                        disabled={processing}
                        className="p-1 hover:bg-gray-100 rounded disabled:opacity-50"
                        title="Decrease priority"
                      >
                        <ArrowDown className="w-4 h-4" />
                      </button>
                    </div>

                    {/* Expiration Controls */}
                    <div className="flex items-center gap-2">
                      {editingExpiration === product.id ? (
                        <div className="flex items-center gap-1">
                          <input
                            type="date"
                            value={expirationDate}
                            onChange={(e) => setExpirationDate(e.target.value)}
                            className="px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                          />
                          <button
                            onClick={() => handleUpdateExpiration(product.id, expirationDate)}
                            disabled={processing}
                            className="p-1 hover:bg-green-100 rounded text-green-600"
                            title="Save expiration"
                          >
                            <Check className="w-3 h-3" />
                          </button>
                          <button
                            onClick={() => {
                              setEditingExpiration(null);
                              setExpirationDate('');
                            }}
                            className="p-1 hover:bg-red-100 rounded text-red-600"
                            title="Cancel"
                          >
                            <AlertTriangle className="w-3 h-3" />
                          </button>
                        </div>
                      ) : (
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => {
                              setEditingExpiration(product.id);
                              setExpirationDate(product.featured_until ? new Date(product.featured_until).toISOString().split('T')[0] : '');
                            }}
                            disabled={processing}
                            className="p-1 hover:bg-gray-100 rounded disabled:opacity-50"
                            title="Edit expiration"
                          >
                            <Edit2 className="w-3 h-3" />
                          </button>
                          {(() => {
                            const status = getExpirationStatus(product);
                            return (
                              <span className={`text-xs flex items-center gap-1 ${status.statusColor}`}>
                                {status.isExpired && <AlertTriangle className="w-3 h-3" />}
                                {status.isExpiringSoon && <Timer className="w-3 h-3" />}
                                {!status.isExpired && !status.isExpiringSoon && <Clock className="w-3 h-3" />}
                                <span className="text-gray-600">{status.statusText}</span>
                              </span>
                            );
                          })()}
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Unfeature Button */}
                <button
                  onClick={() => handleUnfeature(product.id)}
                  disabled={processing}
                  className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors"
                >
                  {processing ? 'Processing...' : 'Remove from Featured'}
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Expired Featured Products */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <AlertTriangle className="w-6 h-6 text-red-500" />
          Expired Featured Products ({expiredFeatured.length})
        </h2>

        {expiredFeatured.length === 0 ? (
          <div className="bg-white rounded-lg border border-gray-200 p-8 text-center">
            <Check className="w-16 h-16 text-green-400 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">No Expired Featured Products</h3>
            <p className="text-gray-600">
              All your featured products are still active
            </p>
          </div>
        ) : (
          <div className="space-y-4">
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
              <p className="text-sm text-amber-700">
                ‚ö†Ô∏è You have {expiredFeatured.length} expired featured products. Choose whether to renew them or remove them from featuring.
              </p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {expiredFeatured.map((product) => (
                <div key={`expired-${product.id}`} className="bg-white rounded-lg border-2 border-red-200 p-4 relative opacity-75">
                  {/* Expired Badge */}
                  <div className="absolute top-2 right-2 z-10">
                    <span className="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded-full border border-red-300">
                      <AlertTriangle className="w-3 h-3" />
                      EXPIRED
                    </span>
                  </div>

                  {/* Product Image */}
                  <div className="relative h-32 bg-gray-100 rounded-lg mb-3">
                    {product.image_url ? (
                      <Image
                        src={product.image_url}
                        alt={product.name}
                        fill
                        className="object-cover rounded-lg opacity-75"
                      />
                    ) : (
                      <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                        <Eye className="w-8 h-8" />
                      </div>
                    )}
                  </div>

                  {/* Product Info */}
                  <div className="mb-3">
                    <h3 className="font-medium text-gray-900 line-clamp-2 text-sm mb-1">
                      {product.title || product.name}
                    </h3>
                    <p className="text-sm font-bold text-gray-900">
                      ${(product.price_cents / 100).toFixed(2)}
                    </p>
                    <p className="text-xs text-gray-500">SKU: {product.sku}</p>
                    
                    {/* Expiration Info */}
                    <div className="mt-2 text-xs text-red-600">
                      {(() => {
                        const status = getExpirationStatus(product);
                        return (
                          <div className="flex items-center gap-1">
                            <AlertTriangle className="w-3 h-3" />
                            <span>Expired {status.daysRemaining === 0 ? 'today' : `${Math.abs(status.daysRemaining)} days ago`}</span>
                          </div>
                        );
                      })()}
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        setEditingExpiration(product.id);
                        setExpirationDate(new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]); // Default to 30 days from now
                      }}
                      disabled={processing}
                      className="flex-1 px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors flex items-center justify-center gap-1"
                    >
                      <Timer className="w-3 h-3" />
                      Renew
                    </button>
                    <button
                      onClick={() => handleUnfeature(product.id)}
                      disabled={processing}
                      className="flex-1 px-3 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors flex items-center justify-center gap-1"
                    >
                      <X className="w-3 h-3" />
                      Remove
                    </button>
                  </div>

                  {/* Renewal Edit Mode */}
                  {editingExpiration === product.id && (
                    <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                      <div className="flex items-center gap-2 mb-2">
                        <label className="text-xs font-medium text-gray-700">New expiration date:</label>
                        <input
                          type="date"
                          value={expirationDate}
                          onChange={(e) => setExpirationDate(e.target.value)}
                          className="flex-1 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-green-500 focus:border-green-500"
                        />
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleUpdateExpiration(product.id, expirationDate)}
                          disabled={processing}
                          className="flex-1 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 disabled:opacity-50"
                        >
                          Save Renewal
                        </button>
                        <button
                          onClick={() => {
                            setEditingExpiration(null);
                            setExpirationDate('');
                          }}
                          className="flex-1 px-2 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* Available Products */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900 mb-4">
          Add Products to Featured
        </h2>

        {/* Search */}
        <div className="mb-4">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
            <input
              type="text"
              placeholder="Search products by name, SKU, or brand..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>

        {/* Products Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {paginatedAvailable.map((product) => (
            <div key={product.id} className="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow">
              <div className="flex gap-3">
                {/* Thumbnail */}
                <div className="relative w-16 h-16 bg-gray-100 rounded flex-shrink-0">
                  {product.image_url ? (
                    <Image
                      src={product.image_url}
                      alt={product.name}
                      fill
                      className="object-cover rounded"
                    />
                  ) : (
                    <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                      <Eye className="w-6 h-6" />
                    </div>
                  )}
                </div>

                {/* Info */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-start justify-between mb-1">
                    <h4 className="font-medium text-sm text-gray-900 truncate">
                      {product.name}
                    </h4>
                    <div className="flex items-center gap-1 ml-2">
                      {getProductTypeIcon(product.product_type)}
                      {product.has_variants && (
                        <Layers className="w-4 h-4 text-purple-500" />
                      )}
                    </div>
                  </div>
                  <p className="text-sm text-gray-600">
                    ${(product.price_cents / 100).toFixed(2)}
                  </p>
                  <p className="text-xs text-gray-500">SKU: {product.sku}</p>
                  <div className="flex items-center justify-between mt-2">
                    <div className="flex items-center gap-2">
                      <span className={`text-xs font-medium ${
                        product.stock > 10 ? 'text-green-600' : 
                        product.stock > 0 ? 'text-yellow-600' : 'text-red-600'
                      }`}>
                        Stock: {product.stock}
                      </span>
                      {getFeaturedTypeBadges(product.featured_types, product.featured_type)}
                    </div>
                  </div>
                </div>
              </div>

              {/* Feature Button */}
              <button
                onClick={() => handleFeature(product.id)}
                disabled={processing || !status?.canFeature}
                className="w-full mt-3 px-3 py-2 bg-amber-600 text-white text-sm rounded-lg hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
              >
                <Star className="w-4 h-4" />
                {processing ? 'Processing...' : 'Feature This Product'}
              </button>
            </div>
          ))}
        </div>

        {/* Pagination Controls */}
        {totalPages > 1 && (
          <div className="mt-6 flex items-center justify-between">
            <div className="text-sm text-gray-600">
              Showing {startIndex + 1} to {Math.min(endIndex, filteredAvailable.length)} of {filteredAvailable.length} products
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setAvailablePage(prev => Math.max(prev - 1, 1))}
                disabled={availablePage === 1}
                className="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Previous
              </button>
              <span className="text-sm text-gray-600">
                Page {availablePage} of {totalPages}
              </span>
              <button
                onClick={() => setAvailablePage(prev => Math.min(prev + 1, totalPages))}
                disabled={availablePage === totalPages}
                className="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Next
              </button>
            </div>
          </div>
        )}

        {filteredAvailable.length === 0 && (
          <div className="text-center py-12 text-gray-500">
            No products found matching "{searchQuery}"
          </div>
        )}
      </div>

      {/* Out of Stock Products - Grouped by Featured Status */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <AlertTriangle className="w-6 h-6 text-red-500" />
          Out of Stock ({outOfStockProducts.length + previouslyFeaturedOutOfStock.length})
        </h2>

        {outOfStockProducts.length === 0 && previouslyFeaturedOutOfStock.length === 0 ? (
          <div className="bg-white rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
            <Package className="w-16 h-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">No Products Out of Stock</h3>
            <p className="text-gray-600">
              All your products have stock available
            </p>
          </div>
        ) : (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div className="flex items-center gap-2 text-red-800">
              <AlertTriangle className="w-5 h-5" />
              <p className="font-medium">
                These products are currently out of stock and cannot be featured. 
                Restock them to make them available for featuring.
              </p>
            </div>
          </div>
        )}

        <div className="space-y-8">
          {(['neverFeatured', 'previouslyFeatured'] as const).map(groupType => {
            const groups = getOutOfStockGroups(outOfStockProducts, previouslyFeaturedOutOfStock);
            const group = groups[groupType];
            if (group.length === 0) return null;
            
            const groupInfo = getOutOfStockGroupInfo(groupType);
            
            return (
              <div key={groupType} className={`rounded-lg border-2 p-6 ${groupInfo.color}`}>
                <div className="flex items-center gap-3 mb-4">
                  <div className={`p-2 rounded-lg ${groupInfo.badgeColor} bg-opacity-10`}>
                    {groupInfo.icon}
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      {groupInfo.title} ({group.length})
                    </h3>
                    <p className="text-sm text-gray-600">{groupInfo.description}</p>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {group.map((product) => (
                    <div key={product.id} className="bg-white rounded-lg border p-4 relative opacity-75">
                      {/* Out of Stock Badge */}
                      <div className="absolute top-2 left-2 z-10">
                        <span className={`inline-flex items-center gap-1 px-2 py-1 ${groupInfo.badgeColor} text-white text-xs font-bold rounded-full`}>
                          <X className="w-3 h-3" />
                          OUT OF STOCK
                        </span>
                      </div>

                      {/* Product Image */}
                      <div className="relative h-32 bg-gray-100 rounded mb-3">
                        {product.image_url ? (
                          <Image
                            src={product.image_url}
                            alt={product.name}
                            fill
                            className="object-cover rounded opacity-50"
                          />
                        ) : (
                          <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                            <Package className="w-8 h-8" />
                          </div>
                        )}
                      </div>

                      {/* Product Info */}
                      <div className="mb-3">
                        {product.brand && (
                          <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">{product.brand}</p>
                        )}
                        <h4 className="font-medium text-gray-900 line-clamp-2 mb-1 text-sm">
                          {product.title || product.name}
                        </h4>
                        <p className="text-sm font-bold text-gray-700">
                          ${(product.price_cents / 100).toFixed(2)}
                        </p>
                        <p className="text-xs text-gray-500">SKU: {product.sku}</p>
                      </div>

                      {/* Action Buttons */}
                      <div className="flex items-center justify-center gap-2">
                        <button
                          className={`px-3 py-1 text-xs font-medium rounded-md ${
                            groupType === 'neverFeatured' ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' :
                            'bg-purple-100 text-purple-700 hover:bg-purple-200'
                          }`}
                        >
                          {groupInfo.action}
                        </button>
                        <button
                          onClick={() => window.open(`/t/${tenantId}/items/${product.id}`, '_blank')}
                          className="px-3 py-1 text-xs font-medium rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200"
                        >
                          Manage
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Inactive Products - Paused Only */}
      <div>
        <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Pause className="w-6 h-6 text-gray-500" />
          Paused Products ({inactiveProducts.length})
        </h2>

        {inactiveProducts.length === 0 ? (
          <div className="bg-white rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
            <Play className="w-16 h-16 text-green-400 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">No Paused Products</h3>
            <p className="text-gray-600">
              All featured products are currently active
            </p>
          </div>
        ) : (
          <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
            <div className="flex items-center gap-2 text-orange-800">
              <Pause className="w-5 h-5" />
              <p className="font-medium">
                These products have been manually paused by you. 
                Toggle them back to active to resume featuring.
              </p>
            </div>
          </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {inactiveProducts.map((product) => (
            <div key={product.id} className="bg-white rounded-lg border-2 border-orange-200 p-4 relative opacity-75">
              {/* Paused Badge */}
              <div className="absolute top-2 left-2 z-10">
                <span className="inline-flex items-center gap-1 px-2 py-1 bg-orange-500 text-white text-xs font-bold rounded-full">
                  <Pause className="w-3 h-3" />
                  PAUSED
                </span>
              </div>

              {/* Product Image */}
              <div className="relative h-48 bg-gray-100 rounded-lg mb-4">
                {product.image_url ? (
                  <Image
                    src={product.image_url}
                    alt={product.name}
                    fill
                    className="object-cover rounded-lg opacity-50"
                  />
                ) : (
                  <div className="absolute inset-0 flex items-center justify-center text-gray-400">
                    <Package className="w-12 h-12" />
                  </div>
                )}
              </div>

              {/* Product Info */}
              <div className="mb-4">
                {product.brand && (
                  <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">{product.brand}</p>
                )}
                <h3 className="font-semibold text-gray-900 line-clamp-2 mb-2">
                  {product.title || product.name}
                </h3>
                <p className="text-lg font-bold text-gray-900">
                  ${(product.price_cents / 100).toFixed(2)}
                </p>
                <p className="text-sm text-orange-600 font-medium">SKU: {product.sku}</p>
              </div>

              {/* Resume Button */}
              <div className="flex items-center justify-center">
                <button
                  className="w-full px-3 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center gap-2"
                >
                  <Play className="w-4 h-4" />
                  Resume Featuring
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Benefits Section */}
      <div className="mt-12 bg-gray-50 rounded-lg p-8">
        <h3 className="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
          <TrendingUp className="w-6 h-6 text-blue-600" />
          Why Feature Products?
        </h3>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="flex gap-4">
            <div className="flex-shrink-0">
              <div className="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                <Star className="w-6 h-6 text-amber-600" />
              </div>
            </div>
            <div>
              <h4 className="font-semibold text-gray-900 mb-1">Stand Out</h4>
              <p className="text-gray-600 text-sm">Featured badge and gradient styling make products impossible to miss</p>
            </div>
          </div>

          <div className="flex gap-4">
            <div className="flex-shrink-0">
              <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                <TrendingUp className="w-6 h-6 text-green-600" />
              </div>
            </div>
            <div>
              <h4 className="font-semibold text-gray-900 mb-1">Boost Sales</h4>
              <p className="text-gray-600 text-sm">Featured products get 3x more clicks and 2x higher conversion rates</p>
            </div>
          </div>

          <div className="flex gap-4">
            <div className="flex-shrink-0">
              <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                <Sparkles className="w-6 h-6 text-blue-600" />
              </div>
            </div>
            <div>
              <h4 className="font-semibold text-gray-900 mb-1">Premium Display</h4>
              <p className="text-gray-600 text-sm">Larger images, enhanced typography, and prominent call-to-action buttons</p>
            </div>
          </div>

          <div className="flex gap-4">
            <div className="flex-shrink-0">
              <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <Check className="w-6 h-6 text-purple-600" />
              </div>
            </div>
            <div>
              <h4 className="font-semibold text-gray-900 mb-1">Easy Management</h4>
              <p className="text-gray-600 text-sm">Feature and unfeature products instantly, adjust priorities with one click</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
