# v3.5 API Implementation Summary

## Overview

This document describes the v3.5 API implementation that builds on the database foundation created in the v3.5 migrations.

## What Was Implemented

### 1. Prisma Schema Updates

**File:** `apps/api/prisma/schema.prisma`

Added 3 new enums:
- `ActorType` - user, system, integration
- `EntityType` - inventory_item, tenant, policy, oauth, other
- `AuditAction` - create, update, delete, sync, policy_apply, oauth_connect, oauth_refresh

Added 3 new models:
- `AuditLog` - Full audit trail with request tracking
- `SkuBillingPolicy` - Current billing policy configuration
- `SkuBillingPolicyHistory` - Temporal policy versions

### 2. API Routes

#### Audit Log API (`src/routes/audit.ts`)

**Endpoints:**
- `GET /admin/audit` - List audit logs with filtering
  - Query params: tenantId, entityType, since, until, cursor, limit
  - Returns: Paginated audit logs
- `GET /admin/audit/:id` - Get single audit log
- `POST /internal/audit` - Create audit log (service-to-service)
- `GET /admin/exports/audit.csv` - Export audit logs as CSV

**Features:**
- Cursor-based pagination
- Time-range filtering
- Entity type filtering
- CSV export for compliance

#### Policy Versioning API (`src/routes/policy.ts`)

**Endpoints:**
- `GET /admin/policy-history` - List policy versions
- `GET /admin/policy-history/:id` - Get single policy version
- `POST /admin/policy-history` - Create new policy version
  - Validates no overlapping periods
  - Auto-tracks updatedBy
- `PATCH /admin/policy-history/:id` - Update policy version
- `DELETE /admin/policy-history/:id` - Delete policy version
- `GET /admin/policy/effective` - Get current effective policy
- `GET /admin/exports/policy-snapshot.json` - Export policy history

**Features:**
- Overlap detection
- Point-in-time policy queries
- JSON export for billing disputes

#### Billing Counters API (`src/routes/billing.ts`)

**Endpoints:**
- `GET /tenant/billing/counters` - Get SKU counters for tenant
  - Returns: active, inactive, archived, public, private, billable counts
  - Includes: policy snapshot, limit, status
- `GET /tenant/billing/status` - Get tier status
  - Returns: billable count, tier, limit, status (ok/warning/at_limit)
- `POST /admin/billing/override` - Set tenant SKU limit
- `GET /metrics/counters` - Real-time counter stream (SSE placeholder)

**Features:**
- Queries materialized view for performance
- Includes policy snapshot in response
- Tier status calculation
- Admin override capability

### 3. Middleware

#### Audit Middleware (`src/middleware/audit.ts`)

**Features:**
- Auto-generates request IDs
- Logs all write operations (POST, PUT, PATCH, DELETE)
- Captures: actor, tenant, entity, action, IP, user agent
- Non-blocking (errors don't fail requests)
- Helper function for manual audit logging

**Usage:**
```typescript
import { auditMiddleware } from './middleware/audit';
app.use('*', auditMiddleware);
```

## Integration Steps

### 1. Generate Prisma Client

```bash
cd apps/api
npx prisma generate
```

### 2. Wire Up Routes

Add to `src/index.ts`:

```typescript
import audit from './routes/audit';
import policy from './routes/policy';
import billing from './routes/billing';
import { auditMiddleware } from './middleware/audit';

// Add audit middleware globally
app.use('*', auditMiddleware);

// Mount routes
app.route('/', audit);
app.route('/', policy);
app.route('/', billing);
```

### 3. Environment Variables

No new environment variables required - uses existing `DATABASE_URL`.

### 4. Deploy

```bash
# Build
pnpm build

# Deploy to Railway (automatic on push)
git push origin spec-sync
```

## API Examples

### Get Audit Logs

```bash
curl "https://api.example.com/admin/audit?tenantId=abc123&limit=10" \
  -H "Authorization: Bearer $TOKEN"
```

### Get Billing Counters

```bash
curl "https://api.example.com/tenant/billing/counters" \
  -H "Authorization: Bearer $TOKEN"
```

Response:
```json
{
  "tenantId": "abc123",
  "counts": {
    "active_total": 100,
    "inactive_total": 5,
    "archived_total": 10,
    "active_public": 95,
    "active_private": 5,
    "billable_sku_count": 100
  },
  "policySnapshot": {
    "scope": "global",
    "count_active_private": true,
    "require_image": true,
    ...
  },
  "limit": 1000,
  "status": "ok"
}
```

### Create Policy Version

```bash
curl -X POST "https://api.example.com/admin/policy-history" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "countActivePrivate": true,
    "countPreorder": true,
    "countZeroPrice": false,
    "requireImage": true,
    "requireCurrency": true,
    "notes": "Updated for Q4 2025"
  }'
```

## Testing

### Manual Testing

```bash
# Start dev server
pnpm dev

# Test audit endpoint
curl http://localhost:3000/admin/audit

# Test counters
curl http://localhost:3000/tenant/billing/counters
```

### Database Queries

```sql
-- Check audit logs
SELECT * FROM audit_log ORDER BY occurred_at DESC LIMIT 10;

-- Check counters
SELECT * FROM tenant_sku_counters;

-- Check policy history
SELECT * FROM sku_billing_policy_history ORDER BY effective_from DESC;
```

## Next Steps

### Immediate
1. ✅ Generate Prisma client
2. ✅ Wire up routes in main app
3. ⚠️ Add auth middleware (requireAuth, requireAdmin)
4. ⚠️ Test endpoints manually
5. ⚠️ Deploy to Railway

### Short-Term
1. Implement real-time counter streaming (NOTIFY/LISTEN)
2. Add WebSocket support for live updates
3. Build admin UI for audit log viewer
4. Build admin UI for policy history
5. Add unit tests for routes

### Medium-Term
1. Add rate limiting
2. Add caching for counter queries
3. Implement DLQ for failed audit logs
4. Add metrics/observability
5. Build dashboard widgets

## Performance Notes

- **Audit logs:** Indexed on tenant_id + occurred_at for fast queries
- **Counters:** Uses materialized view, refresh every 5 minutes
- **Policy queries:** Uses temporal index for point-in-time lookups
- **Pagination:** Cursor-based to avoid offset performance issues

## Security Notes

- All admin endpoints require admin role
- Audit logs capture IP and user agent
- PII scrubbing enabled by default
- Service-to-service auth needed for internal audit endpoint

## Compliance

- Audit logs support GDPR/CCPA data subject requests
- Policy history enables billing dispute resolution
- CSV/JSON exports for compliance audits
- Request ID propagation for incident investigation
