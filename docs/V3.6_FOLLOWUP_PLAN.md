# v3.6 Follow-up Implementation Plan

This document captures remaining work from the v3.6 Master Spec and Technical Requirements to reach full compliance.

## Phase 1 — Tenant Context, Flags, Security (High Priority)
- TR-907 Tenant Context & Routing
  - Add Edge-safe middleware `middleware.ts` with `tenantResolver` to:
    - Resolve `tenantId` → 404 if invalid
    - Set signed HttpOnly `tcx` cookie with `{ tenant_id, tenant_slug, aud }`
    - Inject request-scoped tenant context for SSR
  - 301 redirect map from legacy routes to `/t/{tenantId}/...`
  - Ensure server components read `tenantContext`; client hooks use context, not localStorage
- Feature Flags gating
  - Gate canonical URLs with `FF_TENANT_URLS`
  - Gate App Shell variants with `FF_APP_SHELL_NAV`
  - Gate Categories UI with `FF_CATEGORY_MANAGEMENT_PAGE`
  - Reserve `FF_CATEGORY_QUICK_ACTIONS` for sticky footer
- CSRF Server Validation (TR-905)
  - Issue `csrf` cookie and validate `x-csrf-token` on POST/PATCH/DELETE centrally
  - Align `apps/web/src/lib/api.ts` header injection with server validator

## Phase 2 — Governance & UX Compliance (High Priority)
- Feed Alignment Enforcement (REQ-2025-911)
  - Precheck/job validators to block unmapped public categories when `FF_FEED_ALIGNMENT_ENFORCE=true`
  - Return actionable errors and surface to UI
- Sticky Quick Actions Footer (REQ-2025-912/912A)
  - Product edit footer with CTAs: Align Category • Preview SKUs • Validate Feed • Save & Return
  - Keyboard shortcuts: Alt+G / Alt+V / Alt+S
  - Emit analytics events: `qa_footer_*`

## Phase 3 — Observability & DX (Medium Priority)
- Audit Chain (TR-AUDIT-CHAIN-001)
  - Create `audit_log` table and emit rows for category edits and item updates
  - Include `request_id`, `tenant_id`, scrub PII per schema
- ISR Revalidation (TR-908)
  - Publish event on `inventory_item` or `tenant_category` changes and revalidate `/t/{tenant}` public pages ≤ 60s
- OpenAPI Contracts
  - Document endpoints for categories and item category assignment
- Central API Client Resilience (TR-API-CLIENT-STD)
  - Add retries/backoff (429/5xx) and basic circuit breaker
  - Contract tests for 401 refresh + retry path

## Phase 4 — Platform Ops & Analytics (Medium/Low)
- `v_feed_category_resolved` view
  - Expose resolved local path + Google path for feed serializer
- CI Schema Drift Job (TR-CI-DRIFT-004)
  - Nightly head vs PROD snapshot diff; fail release on drift without approval
- Tenant-weighted RUM (TR-RUM-WEIGHT-005)
  - Weighted sampling and dashboard
- KPI Dashboards
  - Metrics: `category_mapping_coverage_pct`, `feed_approval_rate`, `qa_footer_engagement_rate`, `time_to_alignment_median_ms`, `taxonomy_version_active_age_days`

## Current Implemented (Reference)
- Category assignment UI/UX: Assign modal with tenant categories + Google taxonomy, recent selections
- Items page: category badge, Assign/Change, filter (All/Assigned/Unassigned), educational guides
- Categories page: top educational tip, bottom "What’s Next?" deep links
- Backend APIs: PATCH item category, GET categories (search/mapped/limit/cursor + stats)
- API Client: bearer injection, x-tenant-id & x-csrf-token on writes, `API_BASE_URL` handling

## Acceptance Targets by Phase
- P1: Legacy routes 301 → `/t/{tenantId}`; SSR uses `tcx`; write routes 403 on missing/invalid CSRF
- P2: Enforcement flag blocks unmapped public categories; sticky footer visible with shortcuts + analytics
- P3: Public revalidation ≤ 60s; OpenAPI published; client retries/backoff validated; audit rows emitted
- P4: Feed serializer uses view; CI drift protection; RUM dashboard; KPI dashboards/alerts

## Suggested Ticket Breakdown
- TR-907: Middleware + redirects + tcx
- Flags: Gate routing/shell/categories/footer
- TR-905: CSRF validator + cookie
- REQ-2025-911: Enforcement validators + UI surfacing
- REQ-2025-912: Sticky footer + shortcuts + analytics
- Audit chain: table + emitters
- ISR revalidation hooks
- OpenAPI docs
- API client retries/backoff tests
- View `v_feed_category_resolved`
- CI schema drift job
- RUM weighting + dashboard
- KPI dashboards/alerts
